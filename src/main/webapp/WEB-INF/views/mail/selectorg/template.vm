<div style="padding:0px 0px;width:650px;height:400px;">
    <div>
    <form id="queryForm">
       <table class="tb2 default-table">
            <tr>

                <td>
                <div style="right: 12px;top: 10px;">
                <a href="javascript:;" class="easyui-linkbutton" plain="true" iconcls="icon-ok" onclick="doselect()">选择</a>
                <a href="javascript:;" class="easyui-linkbutton" plain="true" iconcls="icon-redo" onclick="doclose()">取消</a></div>
                </td>
            </tr>
        </table>
    </form>
    </div>
    <form id="dataForm">
        <div style="width:650px;height:50px;border:solid 1px rgb(149,184,231);margin:5px 0 5px 0">
            <div ms-controller="selectedShow">
                <div ms-repeat="selectedSet" style="display:inline">
                    <span>[{{$val.rownumber}}]{{$val[$val.showName]}}&emsp;&emsp;</span>
                </div>
            </div>
        </div>
    </form>
    <table id="peopleTable" class="easyui-datagrid" title="$!{selectDialogTitle}" style="width:100%;height:400px;"
               data-options="fitColumns:true,#if($single)singleSelect:true,#end selectOnCheck:true,rownumbers:true,pagination:true,collapsible:false,url:'$link.getContextURL()$url',pageSize:10,pageList:[10,20,30,50]">
            <thead>
            <tr>
                #if(!$single)<th data-options="field:'id',checkbox:true"></th>#end
                #parse("$tablehead")
            </tr>
            </thead>
        </table>
    </table>

</div>
#@script()
<script src="$link.getContextURL()/lib/avalon/avalon.js"></script>
<script>
    $(document).ready(function() {
        if (top.setSelectDialogFrameDialogTitle) {
            top.setSelectDialogFrameDialogTitle("$!{selectDialogTitle}");
        }
    });

    function formSerach() {
        var f = $("#queryForm").serializeArray();
        var obj ={};
        for(var i = 0;i< f.length;i++){
            obj[f[i].name] = f[i].value;
        }
        $('#peopleTable').datagrid('reload',obj);
        return false;
    }

    function doclose() {
        if (top.closeSelectDialogFrameDialog) {
            top.closeSelectDialogFrameDialog();
        }

        return false;
    }

    //选择操作
    var vm = avalon.define({
        $id: "selectedShow",
        selectedSet:{}
    });
    var objSet={};
    $("#peopleTable").datagrid({
        onSelect:function(index,row){
            var opt = $('#peopleTable').datagrid('options');
            var rownumber = (opt.pageNumber - 1) * opt.pageSize + index + 1;
            var showName = "$showName";
            #if($single)
                objSet["obj"] = row;
                objSet["obj"].rownumber = rownumber;
                objSet["obj"].showName = showName;
            #else
                objSet[row["$idName"]] = row;
                objSet[row["$idName"]].index = index;
                var opt = $('#peopleTable').datagrid('options');
                objSet[row["$idName"]].rownumber = rownumber;
                objSet[row["$idName"]].showName = showName;
            #end
            vm.selectedSet=objSet;
            avalon.scan();
        },
        onSelectAll:function(rows){
            #if(!$single)
                for(var i = 0;i<rows.length;i++){
                    var opt = $('#peopleTable').datagrid('options');
                    var index = $("#peopleTable").datagrid("getRowIndex",rows[i]);
                    var rownumber = (opt.pageNumber - 1) * opt.pageSize + index + 1;
                    objSet[rows[i]["$idName"]] = rows[i];
                    objSet[rows[i]["$idName"]].index = index;
                    objSet[rows[i]["$idName"]].rownumber = rownumber;
                    objSet[rows[i]["$idName"]].showName = "$showName";
                }
            #end
            vm.selectedSet=objSet;
            avalon.scan();
        },
        onUnselectAll:function(rows){
            for(var i = 0;i<rows.length;i++){
                delete objSet[rows[i]["$idName"]];
            }
            vm.selectedSet=objSet;
            avalon.scan();
        },
        onUnselect:function(index,row){
            delete objSet[row["$idName"]];
            vm.selectedSet=objSet;
            avalon.scan();
        },
        onLoadSuccess:function(data){
            $.each(data.rows,function(i,o){
                  var sl = objSet[o["$idName"]];
                  if(sl){
                     $('#peopleTable').datagrid('selectRow',sl.index);
                  }
            });
        }
    });
    //选择
    function doselect() {
        var map = avalon.vmodels.selectedShow.selectedSet;
        var rows = [];
        for(o in map){
            regx = /^(\$|hasOwnProperty|_)/;
            if(!regx.test(o)){
                rows.push(map[o]);
            }
        }
        if (rows.length >0) {
            #if(!$single)
              top.okSelectDialogFrameDialog(rows);
            #else
              top.okSelectDialogFrameDialog(rows[0]);
            #end
        } else {
            alert("请先选择数据。");
        }
        return false;
    }
</script>
<style>
div[ms-controller]{
    display:none;
}
</style>
#end